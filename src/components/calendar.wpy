<style lang="less">
.com-calendar__container {
  .schedule-container {
    background: #fff;
    .calendar-container {
      .calendar-header {
        display: flex;
        text-align: center;
        justify-content: center;
        align-items: center;
        height: 100rpx;
        .prev-month,
        .next-month {
          flex: 0 0 180rpx;
        }
        .cur-month {
          flex: 1;
        }
      }
      .calendar-week {
        display: flex;
        justify-content: center;
        align-items: center;
        border-bottom: 1px solid #efefef;
        .weeks-grid {
          text-align: center;
          flex: 107.1428571429rpx;
          color: #dd5044;
        }
      }
      .calendar-days {
        display: flex;
        flex-wrap: wrap;
        .days-grid {
          // text-align: center;
          height: 100rpx;
          // width: 107.1428571429rpx;
          width: 14.2857%;
          // flex: 0 0 14.2857%;
          border-bottom: 1px solid #eee;
          .day {
            margin: 20rpx auto;
            width: 60rpx;
            height: 60rpx;
            line-height: 60rpx;
            text-align: center;
            font-size: 28rpx;
          }
          .day-active {
            border: 1px solid #dd5044;
            border-radius: 50%;
          }
        }
      }
      .calendar-close {
        margin-top: 60rpx;
        image {
          display: block;
          margin: 0 auto;
          width: 60rpx;
          height: 60rpx;
        }
      }
    }
  }
}
</style>
<template>
  <view class="com-calendar__container">
    <view class="schedule-container">
    <!-- æ—¥å†è¡¨ğŸ“… -->
    <wxc-mask status="{{maskStatus}}" background-color="#fff" opacity="1" class="mask-animation">
      <view class="calendar-container">
        <view class="calendar-header">
          <view class="prev-month" @tap="handleCalendar" data-action="prev">ä¸Šä¸€æœˆ</view>
          <view class="cur-month">{{currentDate}}</view>
          <view class="next-month" @tap="handleCalendar" data-action="next">ä¸‹ä¸€æœˆ</view>  
        </view>
        <view class="calendar-week">
          <repeat for="{{weeks_ch}}" item="week" key="key">
            <view class="weeks-grid">{{week}}</view>
          </repeat>
        </view>
        <view class="calendar-days">
          <block wx:if="{{hasEmptyGrid}}">
            <view class="days-grid" wx:for="{{empytGrids}}" wx:key="{{index}}" data-idx="{{index}}">
            </view>    
          </block>
          <repeat wx:for="{{days}}" key="key" index="index" item="item">
            <view class="days-grid" @tap="handleDayItem({{item.dayDate}})">
              <view class="day {{item.choosed ? 'day-active' : ''}}">{{item.day}}</view>
            </view>
          </repeat>
        </view>
      </view>
    </wxc-mask>
    </view>
  </view>
</template>
<script>
import wepy from "wepy";
import moment from "moment";

export default class Calendar extends wepy.component {
  props = {
    monthOfDays: {
      type: Array,
      default: []
    }
  };
  data = {
    currentDate: moment().format("YYYY-MM-DD"), // è·å–å½“å‰æ—¥æœŸ YYYY-MM-DD
    thisMonthDays: [], // è·å–å½“å‰æœˆä¸€å…±å¤šå°‘å¤©
    currentMonth: parseInt(moment().format("MM")), // å½“å‰æœˆä»½
    currentYear: moment().year(), // å½“å‰å¹´ä»½
    currentDay: moment().dayOfYear(), // å½“å‰å¤©
    days: [], // æ¯ä¸ªæœˆçš„æ¯å¤©æ•°ç»„
    weeks_ch: [],
    empytGrids: [],
    hasEmptyGrid: false,
    maskStatus: "hide",
    todayEntity: [],
    currentDayData: []
  };
  methods = {
    handleCalendar(e) {
      let self = this;
      const { action } = e.currentTarget.dataset;
      const { currentDate } = self.data;
      if (action == "prev") {
        let prevMonth = self.currentMonth - 1;
        let prevYear = self.currentYear;
        console.log(`prev:${prevYear}-${prevMonth}`);
        if (prevMonth < 1) {
          prevYear = self.currentYear - 1;
          prevMonth = 12;
        }
        self.calDays(prevYear, prevMonth);
        self.calEmptyGrid(prevYear, prevMonth);

        self.currentYear = prevYear;
        self.currentDate = moment(currentDate)
          .subtract(1, "months")
          .format("YYYY-MM-DD");
        self.currentMonth = prevMonth;
        self.$apply();
        console.log(`å½“å‰æ—¥æœŸï¼š${currentDate}`);
      } else {
        let nextMonth = self.currentMonth + 1;
        let nextYear = self.currentYear;
        if (nextMonth > 12) {
          nextYear = self.currentYear + 1;
          nextMonth = 1;
        }
        self.calDays(nextYear, nextMonth);
        self.calEmptyGrid(nextYear, nextMonth);

        self.currentYear = nextYear;
        self.currentMonth = nextMonth;
        self.currentDate = moment(currentDate)
          .add(1, "months")
          .format("YYYY-MM-DD");
        self.$apply();
        console.log(`å½“å‰æ—¥æœŸï¼š${currentDate}`);
      }
      // console.log(action)
    },
    handleDayItem(params) {
      console.log('onClickäº‹ä»¶',params)
    }
  };
  onLoad() {
    let self = this;

    const weeks_ch = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"];
    self.calEmptyGrid(self.currentYear, self.currentMonth);
    self.calDays(self.currentYear, self.currentMonth);
    const thisMonthDays = new Date(
      moment().format("YYYY"),
      moment().format("MM"),
      0
    ).getDate();
    self.weeks_ch = weeks_ch;
    self.$apply();
  }
  onShow() {}
  // è®¡ç®—æ¯ä¸ªæœˆçš„è½®ç©ºæ•°
  calEmptyGrid(year, month) {
    let self = this;
    let firstDayOfWeek = new Date(Date.UTC(year, month - 1, 1)).getDay();
    let empytGrids = [];
    if (firstDayOfWeek > 0) {
      for (let i = 0; i < firstDayOfWeek; i++) {
        empytGrids.push(i);
      }
      self.empytGrids = empytGrids;
      self.hasEmptyGrid = true;
      self.$apply();
    } else {
      self.empytGrids = [];
      self.hasEmptyGrid = false;
      self.$apply();
    }
    // console.log(`æ¯ä¸ªæœˆç©ºæ ¼æ•°:${self.empytGrids}`)
  }
  // è·å–å½“æœˆçš„å¤©æ•°
  calDays(year, month) {
    let self = this;
    const { currentDate } = self.data;
    let days = [];
    const thisMonthDays = new Date(year, month, 0).getDate(); // è·å–å½“å‰æœˆçš„å¤©æ•°(eg: 1æœˆ 31å¤©)
    for (let i = 1; i <= thisMonthDays; i++) {
      let choosed =
        currentDate ==
        moment(`${year}-${month}-${i}`, "YYYY-MM-D").format("YYYY-MM-DD")
          ? true
          : false;
      days.push({
        dayDate: moment(`${year}-${month}-${i}`, "YYYY-MM-D").format(
          "YYYY-MM-DD"
        ), // æ¯å¤©çš„å®Œæ•´æ—¥æœŸ
        day: i, // æ¯å¤©çš„ æ—¥
        choosed // æ˜¯å¦æ˜¯å½“å¤©ï¼Œå¦‚æœæ˜¯åˆ™ä¸ºtrue
      });
    }
    self.days = days;
    self.$apply();
    console.log("days", self.days);
  }
}
</script>
